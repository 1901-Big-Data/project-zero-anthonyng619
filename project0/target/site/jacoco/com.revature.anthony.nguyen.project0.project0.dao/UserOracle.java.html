<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserOracle.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project0</a> &gt; <a href="index.source.html" class="el_package">com.revature.anthony.nguyen.project0.project0.dao</a> &gt; <span class="el_source">UserOracle.java</span></div><h1>UserOracle.java</h1><pre class="source lang-java linenums">package com.revature.anthony.nguyen.project0.project0.dao;

import java.sql.CallableStatement;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Types;
import java.util.ArrayList;
import java.util.NoSuchElementException;
import java.util.Optional;
import java.util.regex.Pattern;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.revature.anthony.nguyen.project0.project0.model.AccountChecking;
import com.revature.anthony.nguyen.project0.project0.model.AccountInformation;
import com.revature.anthony.nguyen.project0.project0.model.User;
import com.revature.anthony.nguyen.project0.project0.model.Users;
import com.revature.anthony.nguyen.project0.project0.service.UserService;
import com.revature.anthony.nguyen.project0.project0.util.DBConnection;

public class UserOracle implements UserDao{
	private static UserOracle userOracle;
<span class="fc" id="L26">	private Logger log = LogManager.getLogger(UserOracle.class);</span>
	
<span class="fc" id="L28">	private UserOracle() {</span>
<span class="fc" id="L29">	}</span>
	
	public static UserOracle get() {
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">		if(userOracle == null) {</span>
<span class="fc" id="L33">			userOracle = new UserOracle();</span>
<span class="fc" id="L34">			return userOracle;</span>
		} else {
<span class="nc" id="L36">			return userOracle;</span>
		}
	}
	
	/**
	 * addUser
	 * Queries into the database and sets up a User model wrapped in an optional
	 * to be sent back to the console application
	 * @param String username
	 * @param String password
	 * @param int admin access; 0 or 1 or 2
	 * @return Optional
	 */
	@Override
	public Optional&lt;User&gt; addUser(String username, String password, int adminAccess) {
		// Check username valid
<span class="fc" id="L52">		Pattern p = Pattern.compile(&quot;[^a-zA-Z0-9]&quot;);</span>
<span class="fc" id="L53">		boolean hasSpecialChar = p.matcher(username).find();</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">		if(hasSpecialChar) {</span>
<span class="nc" id="L55">			return Optional.empty();</span>
		}
		
<span class="fc" id="L58">		String query = &quot;call createuser(?, ?, ?, ?)&quot;;</span>
<span class="fc" id="L59">		try(CallableStatement stmt = DBConnection.get().getConnection().prepareCall(query)) {</span>
<span class="fc" id="L60">			stmt.setString(1, username);</span>
<span class="fc" id="L61">			stmt.setString(2, password);</span>
<span class="fc" id="L62">			stmt.setInt(3, adminAccess);	</span>
<span class="fc" id="L63">			stmt.registerOutParameter(4, Types.INTEGER);</span>
<span class="fc" id="L64">			stmt.execute();</span>
			
<span class="fc" id="L66">			Integer userid = stmt.getInt(4);</span>
			
<span class="fc" id="L68">			log.debug(&quot;Added user to database with user id: &quot; + userid);</span>
			
			// Create user
<span class="fc" id="L71">			User user = new User(username, password, adminAccess, userid);</span>
<span class="fc" id="L72">			return Optional.of(user);</span>
<span class="pc bpc" id="L73" title="4 of 8 branches missed.">		} catch(SQLException e) {</span>
<span class="fc" id="L74">			log.catching(e);</span>
<span class="fc" id="L75">			return Optional.empty();</span>
		}
	}

	/**
	 * removeUser
	 * Removes the user from the database when balance is 0 across all checking accounts.
	 * @param int userid
	 * @return Optional
	 */
	@Override
	public Optional&lt;User&gt; removeUser(int userid) {
<span class="fc" id="L87">		String query = &quot;call deleteuser(?, ?)&quot;;</span>
		
<span class="fc" id="L89">		try(CallableStatement stmt = DBConnection.get().getConnection().prepareCall(query)) {</span>
<span class="fc" id="L90">			stmt.setInt(1, userid);</span>
<span class="fc" id="L91">			stmt.registerOutParameter(2, Types.INTEGER);</span>
<span class="fc" id="L92">			stmt.execute();</span>
			
<span class="fc" id="L94">			Integer result = stmt.getInt(2);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">			if(result == 0) {</span>
<span class="fc" id="L96">				return Optional.empty();</span>
			}
			
<span class="fc" id="L99">			User blankuser = new User();</span>
<span class="pc" id="L100">			return Optional.of(blankuser);</span>
			
<span class="pc bpc" id="L102" title="8 of 10 branches missed.">		} catch(SQLException e) {</span>
<span class="nc" id="L103">			log.catching(e);</span>
<span class="nc" id="L104">			return Optional.empty();</span>
		}
	}
	
	/**
	 * removeUserAsAdmin
	 * Force removes a user regardless of balance in the user's accounts. WILL BE WIPED.
	 * @param int userid
	 * @return Optional
	 */
	@
	Override
	public Optional&lt;Users&gt; removeUserAsAdmin(int userid) {
<span class="fc" id="L117">		String query = &quot;call deleteuserasadmin(?, ?)&quot;;</span>
		
<span class="fc" id="L119">		try(CallableStatement stmt = DBConnection.get().getConnection().prepareCall(query)) {</span>
<span class="fc" id="L120">			stmt.setInt(1, userid);</span>
<span class="fc" id="L121">			stmt.registerOutParameter(2, oracle.jdbc.OracleTypes.CURSOR);</span>
<span class="fc" id="L122">			stmt.execute();</span>
		
<span class="fc" id="L124">			ResultSet rs = (ResultSet) stmt.getObject(2);</span>
			
<span class="fc" id="L126">			ArrayList&lt;User&gt; userslist = new ArrayList&lt;User&gt;();</span>
<span class="fc" id="L127">			boolean rsempty = true; // Used to check if resultset is empty</span>
			
<span class="fc bfc" id="L129" title="All 2 branches covered.">			while(rs.next()) {</span>
				//System.out.println(&quot;Looped&quot;);
<span class="fc" id="L131">				rsempty = false;</span>
<span class="fc" id="L132">				int userid_ = rs.getInt(&quot;user_id&quot;);</span>
<span class="fc" id="L133">				String username = rs.getString(&quot;username&quot;);</span>
<span class="fc" id="L134">				User user_info = new User(username, &quot;&quot;, 0, userid_);</span>
<span class="fc" id="L135">				userslist.add(user_info);</span>
			}
			
			if(rsempty) {
				//return Optional.empty();
			}
			
<span class="fc" id="L142">			Users users = new Users(userslist);</span>
<span class="fc" id="L143">			rs.close();</span>
<span class="pc" id="L144">			return Optional.of(users);</span>
<span class="pc bpc" id="L145" title="7 of 8 branches missed.">		} catch(SQLException e) {</span>
<span class="nc" id="L146">			log.catching(e);</span>
<span class="nc" id="L147">			return Optional.empty();</span>
		}
	}

	/**
	 * loginUser
	 * Queries the username and password to DB and returns a User wrapped in an optional
	 * upon success.
	 * @param String username
	 * @param String password
	 * @return Optional
	 */
	@Override
	public Optional&lt;User&gt; loginUser(String username, String password) {
<span class="fc" id="L161">		String query = &quot;select * from p0_users where USERNAME = ? and PASSCODE = ?&quot;;</span>
		
<span class="fc" id="L163">		try(PreparedStatement stmt = DBConnection.get().getConnection().prepareStatement(query)) {</span>
<span class="fc" id="L164">			stmt.setString(1, username.toLowerCase());</span>
<span class="fc" id="L165">			stmt.setString(2, password);</span>
<span class="fc" id="L166">			ResultSet rs = stmt.executeQuery();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">			if(rs.next()) {</span>
<span class="fc" id="L168">				int adminAccess = rs.getInt(&quot;adminaccess&quot;);</span>
<span class="fc" id="L169">				int userid = rs.getInt(&quot;USER_ID&quot;);</span>
<span class="fc" id="L170">				User user = new User(username, password, adminAccess, userid);</span>
<span class="fc" id="L171">				return Optional.of(user);</span>
			}
<span class="pc bpc" id="L173" title="8 of 10 branches missed.">		} catch(SQLException e) {</span>
<span class="nc" id="L174">			log.catching(e);</span>
<span class="nc" id="L175">			return Optional.empty();</span>
		}
<span class="fc" id="L177">		return Optional.empty();</span>
	}
	
	/**
	 * checkUsername
	 * Checks username to see if it contains valid characters or if the username
	 * already exists on the database.
	 * @param String username
	 * @return boolean
	 */
	@Override
	public boolean checkUsername(String username) {
<span class="fc" id="L189">		Pattern p = Pattern.compile(&quot;[^a-zA-Z0-9]&quot;);</span>
<span class="fc" id="L190">		boolean hasSpecialChar = p.matcher(username).find();</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">		if(hasSpecialChar) {</span>
<span class="nc" id="L192">			return true;</span>
		}
<span class="fc" id="L194">		String query = &quot;select * from p0_users where USERNAME = ?&quot;;</span>
		
<span class="fc" id="L196">		try(PreparedStatement stmt = DBConnection.get().getConnection().prepareStatement(query)) {</span>
<span class="fc" id="L197">			stmt.setString(1, username.toLowerCase());</span>
<span class="fc" id="L198">			ResultSet rs = stmt.executeQuery();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">			if(rs.next()) {</span>
<span class="fc" id="L200">				log.debug(username + &quot; exists&quot;);</span>
<span class="fc" id="L201">				rs.close();</span>
<span class="fc" id="L202">				return true;</span>
			}
<span class="pc bpc" id="L204" title="8 of 10 branches missed.">		} catch(SQLException e) {</span>
<span class="nc" id="L205">			log.catching(e);</span>
<span class="nc" id="L206">			return false;</span>
		}
<span class="fc" id="L208">		return false;</span>
	}

	/**
	 * retrieveUsersAsAdmin
	 * Grabs the list of users into a Users model that only the admin has access to.
	 * @return Optional
	 */
	@Override
	public Optional&lt;Users&gt; retrieveUsersAsAdmin() {
<span class="fc" id="L218">		String query = &quot;select *  from p0_users&quot;;</span>
		
<span class="fc" id="L220">		try(PreparedStatement stmt = DBConnection.get().getConnection().prepareStatement(query)) {</span>
<span class="fc" id="L221">			ResultSet rs = stmt.executeQuery();</span>
			
<span class="fc" id="L223">			ArrayList&lt;User&gt; list = new ArrayList&lt;User&gt;();</span>
			
<span class="fc" id="L225">			boolean empty = true;</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L227">				empty = false;</span>
<span class="fc" id="L228">				int userid = rs.getInt(&quot;user_id&quot;);</span>
<span class="fc" id="L229">				String username = rs.getString(&quot;username&quot;);</span>
<span class="fc" id="L230">				User tempuser = new User(username, &quot;&quot;, 0, userid);</span>
<span class="fc" id="L231">				list.add(tempuser);</span>
			}
		
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">			if(empty) {</span>
<span class="nc" id="L235">				rs.close();</span>
<span class="nc" id="L236">				return Optional.empty();</span>
			}
		
<span class="fc" id="L239">			Users users = new Users(list);</span>
<span class="fc" id="L240">			rs.close();</span>
<span class="pc" id="L241">			return Optional.of(users);</span>
<span class="pc bpc" id="L242" title="9 of 10 branches missed.">		} catch(SQLException e) {</span>
<span class="nc" id="L243">			log.catching(e);</span>
<span class="nc" id="L244">			return Optional.empty();</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>